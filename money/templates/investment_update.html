{% extends 'base.html' %}
{% load i18n %}
{% load l10n %}

{% block content %}
    <h1>{% trans "Update an investment" %}</h1>
    <p>{{view.object.accounts.fullName}}</p>
    <form method="post">
        <table>
        {% csrf_token %}
        {{ form.as_table }}
        </table>
    <button type="submit">{% trans "Save" %}</button>
    </form>
    
    <modal-window id="sellingprice" closed>
        <h1>{% trans "Investment data" %}</h1>
        <label id="investmentData"></label>
        <h1>{% trans "Set selling price by price" %}</h1>
        <input type="number" value="{{view.investments_operations.current_average_price_investment.amount|unlocalize}}" id="byprice">
         <button onclick="set_by_price();">{% trans "Set" %}</button> 
        <h1>{% trans "Set selling price by percentage" %}</h1>
        <input type="number" value="5" id="percentage">
         <button onclick="set_by_percentage();">{% trans "Set" %}</button> 
        <h1>{% trans "Set selling price to obtain a predefined gain" %}</h1>
        <input type="number" value="500" id="predefinedGains">
         <button onclick="set_by_predefined_gains();">{% trans "Set" %}</button> 
         <hr>
         <label id="sellingpriceResult">{% trans "Select a method to calculate the investment selling price" %}</label>

    <script>
    var dialog=document.getElementById("sellingprice");
    var txtSellingPrice=document.getElementById("id_selling_price");
    var txtByPrice=dialog.shadowRoot.getElementById("byprice");
    var txtPercentage=dialog.shadowRoot.getElementById("percentage");
    var txtPredefinedGains=dialog.shadowRoot.getElementById("predefinedGains");
    var lblInvestmentData=dialog.shadowRoot.getElementById("investmentData");
    var lblResult=dialog.shadowRoot.getElementById("sellingpriceResult");
    var invested_user=parseFloat({{view.investments_operations.current_invested_user|unlocalize}});
    var leverage=parseFloat({{view.object.products.real_leveraged_multiplier | unlocalize}});
    var average_price_investment=parseFloat({{view.investments_operations.current_average_price_investment.amount|unlocalize}});
    var shares=parseFloat({{view.investments_operations.current_shares | unlocalize}});
    lblInvestmentData.innerHTML=`
<ul>
    <li>Invested: ${invested_user}</li>
    <li>leverage: ${leverage}</li>
    <li>shares: ${shares}</li>
    <li>Average price: ${average_price_investment}</li>
</ul>
`;
    
    function open_sellingprice_dialog(){
        dialog.show();
    }
    
    function set_by_price(){
        return display_result(parseNumber(txtByPrice.value));
    }

    function set_by_percentage(){
        return display_result(selling_price_to_gain_percentage_of_invested(parseFloat(txtSellingPrice.value)));
    }

    function set_by_predefined_gains(){
        return display_result(selling_price_to_gain_money(parseFloat(txtPredefinedGains.value)));
    }
    
    function selling_price_to_gain_percentage_of_invested(percentage){
        var gains=invested_user*(parseFloat(txtPercentage.value)/100);
        return self.selling_price_to_gain_money(gains);
    }

    function selling_price_to_gain_money(money){
        var PF=0;
        if (shares>0){
            PF=(money+average_price_investment*shares*leverage)/(shares*leverage)        
        } 
        else if (shares<0){
            PF=(-money+average_price_investment*shares*leverage)/(shares*leverage)        
        }
        return PF;
    }
    
    function gains_at_price(price){
        return gains=(price-average_price_investment)*shares*leverage
    }
    
    
    function display_result(selling_price){
        lblResult.innerHTML=`Investment selling price set to ${selling_price} to gain ${gains_at_price(selling_price)}.`;
        txtSellingPrice.value=selling_price;
        return;
    }
    </script>
</modal-window>
    

    
    <p class="orders">
        <a onclick="open_sellingprice_dialog();" href="javascript:void(0);">{% trans "Calculate selling price" %}</a> | 
        <a href="{% url 'investment_delete' pk=object.id %}">{% trans "Delete this investment" %}</a>
    </p>

{% endblock %}
